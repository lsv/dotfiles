- name: Stat ssh agent
  stat:
    path: /home/{{ username }}/.config/plasma-workspace/env/ssh-agent-startup.sh
  register: ssh_agent_installed

- name: Setup ssh agent script on startup
  copy:
    mode: 'go+r,u+rwx'
    dest: /home/{{ username }}/.config/plasma-workspace/env/ssh-agent-startup.sh
    content: |
      #!/bin/bash

      [ -n "$SSH_AGENT_PID"] || eval "$(ssh-agent -s)"
  when: not ssh_agent_installed.stat.exists

- name: Setup ssh add keys script on login
  copy:
    mode: 'go+r,u+rwx'
    dest: /home/{{ username }}/.config/autostart-scripts/ssh-add.sh
    content: |
      #!/bin/bash

      export SSH_ASKPASS=/usr/bin/ksshaskpass

      ssh-add $HOME/.ssh/id_rsa
  when: not ssh_agent_installed.stat.exists

- name: Setup ssh agent stop script on shutdown
  copy:
    mode: 'go+r,u+rwx'
    dest: /home/{{ username }}/.config/plasma-workspace/shutdown/ssh-agent-shutdown.sh
    content: |
      #!/bin/bash

      [-z "$SSH\_AGENT\_PID"] || eval "$(ssh-agent -k)"
  when: not ssh_agent_installed.stat.exists
